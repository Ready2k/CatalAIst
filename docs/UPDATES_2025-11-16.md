# Updates - November 16, 2025

## Prompt Storage Consolidation & Version Bumping

### Summary

Consolidated prompt storage to a single location and implemented automatic semantic version bumping for all prompt edits.

### Changes Made

#### 1. Prompt Storage Location Clarified

**Before**: Confusion between two directories
- `./data/prompts/` (empty, unused)
- `./backend/data/prompts/` (actual location)

**After**: Single source of truth
- **`backend/data/prompts/`** - The ONLY location for prompts
- Removed unused root `data/` directory
- Updated all documentation to reflect correct path

#### 2. Automatic Version Bumping Implemented

**Feature**: When admins edit prompts via UI, version automatically bumps

**Behavior**:
- First save: Creates `v1.0`
- Subsequent saves: Auto-bumps patch version (`v1.0` ‚Üí `v1.0.1` ‚Üí `v1.0.2`)
- Manual versioning: Still supported for major/minor bumps

**Implementation**:
- Modified `VersionedStorageService.savePrompt()` method
- Parses latest version and increments patch number
- Maintains backward compatibility

**Example**:
```
classification-v1.0.txt      (initial)
classification-v1.0.1.txt    (auto-bumped after edit)
classification-v1.0.2.txt    (auto-bumped after edit)
classification-v1.1.0.txt    (manual minor bump)
classification-v2.0.0.txt    (manual major bump)
```

#### 3. Git Tracking Improved

**Before**: `.gitignore` only tracked `*-v1.*.txt` (e.g., v1.0, v1.1)

**After**: Tracks all versions `*-v*.txt` (e.g., v1.0, v1.0.1, v1.1.1, v2.0)

**Pattern**:
```gitignore
backend/data/*
!backend/data/prompts/
backend/data/prompts/*
!backend/data/prompts/.gitkeep
!backend/data/prompts/*-v*.txt
```

#### 4. Documentation Added/Updated

**New Documentation**:
1. **`docs/PROMPT_STORAGE_LOCATION.md`** - Definitive guide on where prompts are stored
2. **`docs/ATTRIBUTE_EXTRACTION_USAGE.md`** - Comprehensive guide on attribute extraction
3. **`docs/prompt-version-bumping-implementation.md`** - Technical implementation details
4. **`PROMPT_STORAGE_CONSOLIDATION.md`** - Analysis and migration guide
5. **`CLEANUP_DATA_DIRECTORIES.sh`** - Script to clean up unused directories

**Updated Documentation**:
1. **`docs/PROMPT_VERSIONING.md`** - Updated paths from `data/prompts/` to `backend/data/prompts/`
2. **`.kiro/steering/prompt-management-policy.md`** - Added version bumping section and storage location

### Benefits

#### 1. Audit Trail
- Every prompt change is versioned
- Full history retained in git
- Can track which version was used for each classification

#### 2. A/B Testing Ready
- Multiple versions can coexist
- Can compare performance between versions
- Easy rollback to previous versions

#### 3. No Manual Work
- Admins don't need to specify versions for minor edits
- Automatic patch bumping handles most cases
- Manual versioning available for major changes

#### 4. Simplified Storage
- One location eliminates confusion
- Clear documentation
- Easier backups and maintenance

### Technical Details

#### Version Bumping Logic

```typescript
async savePrompt(promptId: string, content: string, version?: string): Promise<string> {
  if (version) {
    return version; // Manual version specified
  }
  
  const existingVersions = await this.listPromptVersions(promptId);
  
  if (existingVersions.length === 0) {
    return '1.0'; // First version
  }
  
  const latestVersion = existingVersions[0]; // Sorted descending
  const parts = latestVersion.split('.');
  const major = parseInt(parts[0]) || 1;
  const minor = parseInt(parts[1]) || 0;
  const patch = parts.length > 2 ? parseInt(parts[2]) || 0 : 0;
  
  return `${major}.${minor}.${patch + 1}`; // Bump patch
}
```

#### Storage Service Configuration

All route files use:
```typescript
const dataDir = process.env.DATA_DIR || './data';
```

**Local Development**: 
- No `DATA_DIR` set ‚Üí uses `./data`
- Working directory is `backend/` ‚Üí resolves to `backend/data/`

**Docker Production**:
- `DATA_DIR=/data` set in .env
- Docker mounts `./backend/data` to `/data` in container

### Testing

#### Automated Tests
Created and ran comprehensive test suite verifying:
- ‚úÖ First save creates v1.0
- ‚úÖ Second save bumps to v1.0.1
- ‚úÖ Third save bumps to v1.0.2
- ‚úÖ Manual version specification works
- ‚úÖ Auto-bump continues from manual version
- ‚úÖ Version listing returns all versions
- ‚úÖ Latest version retrieval works
- ‚úÖ Specific version retrieval works

All tests passed successfully.

#### Manual Testing
- ‚úÖ Backend compiles without errors
- ‚úÖ Prompts load correctly on startup
- ‚úÖ Prompt editing via UI works
- ‚úÖ Version bumping works as expected
- ‚úÖ Git tracking works for all version formats

### Migration Notes

#### For Existing Installations

If you have prompts in root `./data/prompts/`:

```bash
# 1. Copy to backend
cp data/prompts/*.txt backend/data/prompts/

# 2. Verify
ls -la backend/data/prompts/

# 3. Test
cd backend && npm run dev

# 4. If working, remove root data
rm -rf data/

# 5. Commit
git add backend/data/prompts/*.txt
git rm -r data/
git commit -m "Migrate prompts to backend/data/prompts/"
```

#### For New Installations

No action needed - prompts will be initialized in `backend/data/prompts/` on first startup.

### Usage

#### Editing Prompts

1. Login as admin
2. Navigate to "Prompts" tab
3. Select prompt
4. Click "‚úèÔ∏è Edit"
5. Make changes
6. Click "üíæ Save Changes"
7. Version automatically bumps (e.g., 1.1 ‚Üí 1.1.1)

#### Committing Changes

```bash
# Check what changed
git status backend/data/prompts/

# Add new versions
git add backend/data/prompts/*-v*.txt

# Commit
git commit -m "Updated classification prompt to v1.1.1 - improved rationale"

# Push
git push
```

### Files Changed

- **Modified**:
  - `.gitignore` - Updated to track all prompt versions
  - `.kiro/steering/prompt-management-policy.md` - Added version bumping section
  - `docs/PROMPT_VERSIONING.md` - Updated paths
  - `backend/src/services/versioned-storage.service.ts` - Implemented auto-bumping

- **Added**:
  - `docs/PROMPT_STORAGE_LOCATION.md`
  - `docs/ATTRIBUTE_EXTRACTION_USAGE.md`
  - `docs/prompt-version-bumping-implementation.md`
  - `PROMPT_STORAGE_CONSOLIDATION.md`
  - `CLEANUP_DATA_DIRECTORIES.sh`

- **Removed**:
  - `data/prompts/.gitkeep` (unused directory removed)

### Commit

```
commit 9e958cf
Author: James Cregeen
Date: November 16, 2025

Consolidate prompt storage and improve documentation

- Clarified prompt storage location: backend/data/prompts/
- Removed unused root data/ directory
- Updated .gitignore to track all prompt versions
- Implemented automatic semantic version bumping
- Added comprehensive documentation
- Updated steering rules
```

### Next Steps

1. ‚úÖ Documentation complete
2. ‚úÖ Code implemented and tested
3. ‚úÖ Changes committed and pushed to git
4. üîÑ Monitor prompt edits to ensure version bumping works in production
5. üîÑ Consider adding version comparison UI (future enhancement)
6. üîÑ Consider adding rollback button in Prompt Manager (future enhancement)

---

**Status**: ‚úÖ Complete and Deployed
**Version**: 3.0.0
**Date**: November 16, 2025
